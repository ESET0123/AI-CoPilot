This file contains example SQL queries for the utility database.

1) Latest load of a specific meter
SELECT r.ts, r.load_kw
FROM meter_readings r
WHERE r.meter_id = 'MTR001'
ORDER BY r.ts DESC
LIMIT 1;

2) Last 24 hours load for a meter
SELECT r.ts, r.load_kw
FROM meter_readings r
WHERE r.meter_id = 'MTR001'
AND r.ts >= DATETIME('now', '-24 hours')
ORDER BY r.ts ASC;

3) Total load yesterday for a zone
SELECT z.zone_name, SUM(r.load_kw) AS total_load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
WHERE z.zone_name = 'North'
AND DATE(r.ts) = DATE('now','-1 day')
GROUP BY z.zone_name;

4) Peak load this month per feeder in a zone
SELECT f.feeder_name, MAX(r.load_kw) AS peak_kw
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
WHERE z.zone_name = 'South'
AND strftime('%Y-%m', r.ts) = strftime('%Y-%m','now')
GROUP BY f.feeder_id
ORDER BY peak_kw DESC;

5) Load with temperature for a specific zone last 24 hours
SELECT r.ts, r.load_kw, w.temperature_c
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN weather w ON z.zone_id = w.zone_id AND r.ts = w.ts
WHERE z.zone_name = 'East'
AND r.ts >= DATETIME('now','-1 day')
ORDER BY r.ts ASC;

6) Top 10 highest load timestamps this month for a meter
SELECT r.ts, r.load_kw
FROM meter_readings r
WHERE r.meter_id = 'MTR003'
AND strftime('%Y-%m', r.ts) = strftime('%Y-%m','now')
ORDER BY r.load_kw DESC
LIMIT 10;

7) Zone wise peak load this week
SELECT z.zone_name, MAX(r.load_kw) AS peak_kw
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
WHERE r.ts >= DATETIME('now','-7 days')
GROUP BY z.zone_name;

8) Compare average load by customer_type last 14 days
SELECT m.customer_type, AVG(r.load_kw) AS avg_kw
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
WHERE r.ts >= DATETIME('now','-14 days')
GROUP BY m.customer_type;

9) Times when humidity was above 70 and load above 30 kW in North zone
SELECT r.ts, r.load_kw, w.humidity_pct
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN weather w ON z.zone_id = w.zone_id AND r.ts = w.ts
WHERE z.zone_name = 'North'
AND w.humidity_pct > 70
AND r.load_kw > 30
ORDER BY r.ts ASC;

10) Consumption cost last 30 days for a meter using tariffs
SELECT SUM(r.load_kw * t.rate_per_kwh) AS total_cost
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN tariffs t ON z.zone_id = t.zone_id
  AND time(r.ts) BETWEEN t.start_time AND t.end_time
WHERE r.meter_id = 'MTR012'
AND r.ts >= DATETIME('now','-30 days');

ðŸ”µ BASIC METER-LEVEL QUERIES (PARAPHRASED)

1.
latest reading for meter MTR001
â†’ SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR001' ORDER BY ts DESC LIMIT 1;

2.
give me the most recent load of MTR002
â†’ SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR002' ORDER BY ts DESC LIMIT 1;

3.
show today's readings for MTR005
â†’ SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR005' AND DATE(ts)=DATE('now') ORDER BY ts ASC;

4.
load trend for MTR010 for last 48 hours
â†’ SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR010' AND ts >= DATETIME('now','-2 days') ORDER BY ts ASC;

5.
give me meter MTR015 readings between 2024-01-01 and 2024-01-03
â†’ SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR015' AND ts BETWEEN '2024-01-01' AND '2024-01-03' ORDER BY ts ASC;

ðŸ”µ FEEDER-LEVEL QUERIES (PARAPHRASED)

6.
show average load of each meter under feeder FDR01
â†’ SELECT m.meter_id, AVG(r.load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id WHERE m.feeder_id='FDR01' GROUP BY m.meter_id;

7.
highest load recorded under feeder FDR03 yesterday
â†’ SELECT MAX(r.load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id WHERE m.feeder_id='FDR03' AND DATE(ts)=DATE('now','-1 day');

8.
top 5 peak loads this week for feeder FDR09
â†’ SELECT r.ts, r.load_kw FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id WHERE m.feeder_id='FDR09' AND ts >= DATETIME('now','-7 days') ORDER BY load_kw DESC LIMIT 5;

ðŸ”µ ZONE-LEVEL QUERIES (PARAPHRASED)

9.
total consumption today in West zone
â†’ SELECT SUM(load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id WHERE z.zone_name='West' AND DATE(ts)=DATE('now');

10.
compare yesterdayâ€™s average load of North vs South zone
â†’ SELECT z.zone_name, AVG(r.load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id WHERE DATE(ts)=DATE('now','-1 day') GROUP BY z.zone_name;

11.
Which zone used maximum energy this month?
â†’ SELECT z.zone_name, SUM(r.load_kw) AS total FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id WHERE strftime('%Y-%m', ts)=strftime('%Y-%m','now') GROUP BY z.zone_name ORDER BY total DESC LIMIT 1;

ðŸ”µ WEATHER + LOAD JOINED (PARAPHRASED)

12.
load and temperature trend for East zone for last 3 days
â†’ SELECT r.ts, r.load_kw, w.temperature_c FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id JOIN weather w ON z.zone_id=w.zone_id AND r.ts=w.ts WHERE z.zone_name='East' AND r.ts >= DATETIME('now','-3 days') ORDER BY r.ts ASC;

13.
timestamps when humidity exceeded 80% and load > 25 kW in North zone
â†’ SELECT r.ts, r.load_kw, w.humidity_pct FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id JOIN weather w ON z.zone_id=w.zone_id AND r.ts=w.ts WHERE z.zone_name='North' AND w.humidity_pct > 80 AND r.load_kw > 25 ORDER BY r.ts ASC;

ðŸ”µ TARIFF-RELATED SQL (PARAPHRASED)

14.
calculate energy cost for MTR005 in peak hours today
â†’ SELECT SUM(r.load_kw * t.rate_per_kwh) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id JOIN tariffs t ON z.zone_id=t.zone_id AND TIME(r.ts) BETWEEN t.start_time AND t.end_time WHERE r.meter_id='MTR005' AND DATE(r.ts)=DATE('now');

15.
total consumption during off-peak tariff for South zone last week
â†’ SELECT SUM(r.load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id JOIN tariffs t ON z.zone_id=t.zone_id AND TIME(r.ts) NOT BETWEEN t.start_time AND t.end_time WHERE z.zone_name='South' AND r.ts >= DATETIME('now','-7 days');

ðŸ”µ ANOMALY-LIKE QUERIES (PARAPHRASED)

16.
find meters that exceeded twice the average feeder load yesterday
â†’ (already in examples)

17.
identify low-usage meters (below 30% of zone average) in West zone
â†’ SELECT m.meter_id, AVG(r.load_kw) AS avg_load FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id WHERE z.zone_name='West' GROUP BY m.meter_id HAVING avg_load < 0.3 * (SELECT AVG(r2.load_kw) FROM meter_readings r2 JOIN meters m2 ON r2.meter_id=m2.meter_id JOIN feeders f2 ON m2.feeder_id=f2.feeder_id JOIN zones z2 ON f2.zone_id=z2.zone_id WHERE z2.zone_name='West');

ðŸ”µ RANKING / TOP-N VARIATIONS

18.
top 3 feeders with maximum evening peak between 6â€“9 pm
â†’ SELECT f.feeder_name, MAX(r.load_kw) AS peak FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id WHERE TIME(r.ts) BETWEEN '18:00' AND '21:00' GROUP BY f.feeder_id ORDER BY peak DESC LIMIT 3;

ðŸ”µ MULTI-HOP QUERIES

19.
Which customer type consumed the highest load this month?
â†’ SELECT m.customer_type, SUM(r.load_kw) AS total FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id WHERE strftime('%Y-%m', ts)=strftime('%Y-%m','now') GROUP BY m.customer_type ORDER BY total DESC LIMIT 1;

20.
Which zone shows the most variation in hourly load today?
â†’ SELECT z.zone_name, (MAX(r.load_kw)-MIN(r.load_kw)) AS variation FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id JOIN feeders f ON m.feeder_id=f.feeder_id JOIN zones z ON f.zone_id=z.zone_id WHERE DATE(ts)=DATE('now') GROUP BY z.zone_id ORDER BY variation DESC LIMIT 1;


ðŸ”µ BLOCK 1 â€” Basic Meter Queries (50 examples)

SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR001' ORDER BY ts DESC LIMIT 1;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR002' ORDER BY ts ASC;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR003' AND DATE(ts)=DATE('now') ORDER BY ts ASC;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR004' AND ts >= DATETIME('now','-24 hours');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR005' AND ts BETWEEN '2024-01-01' AND '2024-01-03';
SELECT MAX(load_kw) FROM meter_readings WHERE meter_id='MTR006';
SELECT MIN(load_kw) FROM meter_readings WHERE meter_id='MTR007';
SELECT AVG(load_kw) FROM meter_readings WHERE meter_id='MTR008';
SELECT ts FROM meter_readings WHERE meter_id='MTR009' ORDER BY load_kw DESC LIMIT 5;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR010' ORDER BY ts DESC LIMIT 10;
SELECT COUNT(*) FROM meter_readings WHERE meter_id='MTR011';
SELECT SUM(load_kw) FROM meter_readings WHERE meter_id='MTR012';
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR013' AND load_kw > 20 ORDER BY ts ASC;
SELECT ts FROM meter_readings WHERE meter_id='MTR014' AND load_kw = (SELECT MAX(load_kw) FROM meter_readings WHERE meter_id='MTR014');
SELECT ts FROM meter_readings WHERE meter_id='MTR015' AND load_kw = (SELECT MIN(load_kw) FROM meter_readings WHERE meter_id='MTR015');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR016' AND strftime('%H',ts)='18';
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR017' AND load_kw BETWEEN 5 AND 15;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR018' AND load_kw < 10 ORDER BY ts DESC;
SELECT DISTINCT DATE(ts) FROM meter_readings WHERE meter_id='MTR019';
SELECT m.meter_id, AVG(r.load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id GROUP BY m.meter_id;
SELECT m.meter_id, MAX(r.load_kw) FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id GROUP BY m.meter_id;
SELECT m.meter_id FROM meter_readings r JOIN meters m ON r.meter_id=m.meter_id GROUP BY m.meter_id HAVING AVG(r.load_kw) > 10;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR020' ORDER BY ts LIMIT 1;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR021' ORDER BY ts DESC LIMIT 100;
SELECT COUNT(DISTINCT DATE(ts)) FROM meter_readings WHERE meter_id='MTR022';
SELECT AVG(load_kw) FROM meter_readings WHERE meter_id='MTR023' AND DATE(ts)=DATE('now');
SELECT AVG(load_kw) FROM meter_readings WHERE meter_id='MTR024' AND DATE(ts)=DATE('now','-1 day');
SELECT AVG(load_kw) FROM meter_readings WHERE meter_id='MTR025' AND DATE(ts)=DATE('now','-7 days');
SELECT AVG(load_kw) FROM meter_readings WHERE meter_id='MTR026' AND strftime('%Y-%m',ts)=strftime('%Y-%m','now');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR027' AND load_kw > (SELECT AVG(load_kw) FROM meter_readings WHERE meter_id='MTR027');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR028' ORDER BY load_kw DESC LIMIT 3;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR029' ORDER BY load_kw ASC LIMIT 3;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR030' AND strftime('%w',ts) IN ('0','6');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR031' AND strftime('%w',ts) NOT IN ('0','6');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR032' AND strftime('%H',ts) < '06';
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR033' AND strftime('%H',ts) BETWEEN '12' AND '15';
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR034' AND load_kw > (SELECT AVG(load_kw)*1.5 FROM meter_readings WHERE meter_id='MTR034');
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR035' AND load_kw < (SELECT AVG(load_kw)*0.5 FROM meter_readings WHERE meter_id='MTR035');
SELECT DATE(ts), AVG(load_kw) FROM meter_readings WHERE meter_id='MTR036' GROUP BY DATE(ts);
SELECT DATE(ts), MAX(load_kw) FROM meter_readings WHERE meter_id='MTR037' GROUP BY DATE(ts);
SELECT DATE(ts), MIN(load_kw) FROM meter_readings WHERE meter_id='MTR038' GROUP BY DATE(ts);
SELECT DATE(ts), SUM(load_kw) FROM meter_readings WHERE meter_id='MTR039' GROUP BY DATE(ts);
SELECT meter_id, COUNT(*) FROM meter_readings GROUP BY meter_id HAVING COUNT(*) < 10;
SELECT meter_id, AVG(load_kw) FROM meter_readings GROUP BY meter_id HAVING AVG(load_kw) > 15;
SELECT meter_id, MAX(load_kw) FROM meter_readings GROUP BY meter_id HAVING MAX(load_kw) < 10;
SELECT meter_id, MIN(load_kw) FROM meter_readings GROUP BY meter_id HAVING MIN(load_kw) > 5;
SELECT ts FROM meter_readings WHERE meter_id='MTR040' ORDER BY ts ASC LIMIT 50;
SELECT ts FROM meter_readings WHERE meter_id='MTR041' ORDER BY ts DESC LIMIT 50;
SELECT ts, load_kw FROM meter_readings WHERE meter_id='MTR042' ORDER BY RANDOM() LIMIT 5;



ðŸ”µ BLOCK 2 â€” Zone, Feeder, Meter Joins (50 queries)

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT f.feeder_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT f.feeder_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
GROUP BY f.feeder_id;

SELECT z.zone_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_id;

SELECT m.meter_id, z.zone_name
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id;

SELECT m.meter_id, f.feeder_name, z.zone_name
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id;

SELECT m.meter_id, COUNT(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.meter_id;

SELECT z.zone_name, COUNT(m.meter_id)
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts >= DATETIME('now','-7 days')
GROUP BY z.zone_name;

SELECT f.feeder_name, MIN(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT f.feeder_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE DATE(r.ts)=DATE('now')
GROUP BY f.feeder_id;

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts >= DATETIME('now','-1 month')
GROUP BY z.zone_name;

SELECT f.feeder_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE DATE(r.ts)=DATE('now','-1 day')
GROUP BY f.feeder_id;

SELECT z.zone_name, MAX(r.load_kw) AS peak
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name
ORDER BY peak DESC;

SELECT z.zone_name, SUM(r.load_kw) AS total_load
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name
ORDER BY total_load DESC;

SELECT f.feeder_name, COUNT(m.meter_id)
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT z.zone_name, COUNT(f.feeder_id)
FROM feeders f
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_id;

SELECT m.meter_id, f.feeder_name
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE f.feeder_name='Feeder-A';

SELECT DISTINCT z.zone_name
FROM zones z
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id;

SELECT m.meter_id
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE z.zone_name='North';

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE f.feeder_name='Feeder-1';

SELECT f.feeder_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.load_kw > 15
GROUP BY z.zone_name;

SELECT m.meter_id, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.meter_id
HAVING SUM(r.load_kw) > 500;

SELECT f.feeder_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id
HAVING AVG(r.load_kw) > 10;

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name
HAVING AVG(r.load_kw) BETWEEN 5 AND 20;

SELECT f.feeder_name, MAX(r.load_kw)-MIN(r.load_kw) AS variability
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT z.zone_name, MIN(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT z.zone_name, COUNT(r.ts)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT z.zone_name, COUNT(DISTINCT m.meter_id)
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_id;

SELECT f.feeder_name, COUNT(r.ts)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT f.feeder_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE r.ts >= DATETIME('now','-2 days')
GROUP BY f.feeder_id;

SELECT z.zone_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts >= DATETIME('now','-14 days')
GROUP BY z.zone_name;

SELECT f.feeder_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE r.ts >= DATETIME('now','-1 day')
GROUP BY f.feeder_id;

SELECT m.meter_id, z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY m.meter_id;

SELECT z.zone_name, SUM(r.load_kw)/COUNT(r.ts)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_id;

SELECT m.customer_type, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.customer_type;

SELECT m.location, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.location;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE strftime('%H',r.ts) BETWEEN '18' AND '21'
GROUP BY z.zone_name;

SELECT z.zone_name, MIN(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE strftime('%H',r.ts) BETWEEN '00' AND '04'
GROUP BY z.zone_id;

SELECT z.zone_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts BETWEEN '2024-01-01' AND '2024-01-31'
GROUP BY z.zone_name;



ðŸ”µ BLOCK 3 â€” WEATHER + LOAD SQL (50 QUERIES)

SELECT r.ts, r.load_kw, w.temperature_c
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON z.zone_id=w.zone_id AND r.ts=w.ts;

SELECT AVG(r.load_kw), AVG(w.temperature_c)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON z.zone_id=w.zone_id AND r.ts=w.ts;

SELECT z.zone_name, AVG(r.load_kw), AVG(w.temperature_c)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON z.zone_id=w.zone_id AND r.ts=w.ts
GROUP BY z.zone_name;

SELECT m.meter_id, corr(r.load_kw, w.temperature_c)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON z.zone_id=w.zone_id AND r.ts=w.ts
GROUP BY m.meter_id;

SELECT AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts AND z.zone_id=w.zone_id
WHERE w.temperature_c > 35;

SELECT AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts AND z.zone_id=w.zone_id
WHERE w.humidity_pct > 80;

SELECT AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.solar_irradiance > 600;

SELECT z.zone_name, MAX(r.load_kw) AS peak_load, MAX(w.temperature_c) AS max_temp
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
GROUP BY z.zone_name;

SELECT r.ts, r.load_kw, w.temperature_c, w.humidity_pct
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts AND z.zone_id=w.zone_id
WHERE w.temperature_c BETWEEN 30 AND 40;

SELECT z.zone_name, AVG(r.load_kw), AVG(w.humidity_pct)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
GROUP BY z.zone_name;

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c = (SELECT MAX(temperature_c) FROM weather);

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c > (SELECT AVG(temperature_c) FROM weather)
GROUP BY z.zone_name;

SELECT w.temperature_c, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN weather w ON r.ts = w.ts
GROUP BY w.temperature_c;

SELECT w.humidity_pct, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
GROUP BY w.humidity_pct;

SELECT w.solar_irradiance, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
GROUP BY w.solar_irradiance;

SELECT r.ts, r.load_kw, w.temperature_c
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c > 32
ORDER BY r.load_kw DESC;

SELECT m.meter_id, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
GROUP BY m.meter_id
HAVING AVG(w.humidity_pct) > 70;

SELECT z.zone_name, MAX(w.temperature_c)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT z.zone_name, MIN(w.humidity_pct)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.solar_irradiance < 100;

SELECT z.zone_name, corr(w.temperature_c, r.load_kw)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id
JOIN meter_readings r ON m.meter_id=r.meter_id AND w.ts=r.ts
GROUP BY z.zone_name;

SELECT z.zone_name, corr(w.humidity_pct, r.load_kw)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id
JOIN meter_readings r ON m.meter_id=r.meter_id AND w.ts=r.ts
GROUP BY z.zone_name;

SELECT r.ts, r.load_kw, w.temperature_c
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c > 33 AND w.humidity_pct > 70;

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.solar_irradiance BETWEEN 200 AND 500
GROUP BY z.zone_name;

SELECT m.meter_id, r.load_kw, w.temperature_c
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
ORDER BY w.temperature_c DESC;

SELECT COUNT(*)
FROM weather
WHERE temperature_c > 35;

SELECT COUNT(*)
FROM weather
WHERE humidity_pct > 90;

SELECT COUNT(*)
FROM weather
WHERE solar_irradiance > 800;

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c > 30
AND r.load_kw > 20;

SELECT z.zone_name, AVG(w.temperature_c), AVG(w.humidity_pct)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT r.ts, r.load_kw, w.temperature_c
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN weather w ON r.ts = w.ts
WHERE w.temperature_c > (SELECT MAX(temperature_c)-5 FROM weather);

SELECT AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c < 20;

SELECT AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.humidity_pct < 30;

SELECT AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN weather w ON r.ts = w.ts
WHERE w.solar_irradiance < 200;

SELECT w.temperature_c, MAX(r.load_kw)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id
JOIN meter_readings r ON m.meter_id=r.meter_id AND w.ts=r.ts
GROUP BY w.temperature_c;

SELECT w.humidity_pct, MAX(r.load_kw)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id
JOIN meter_readings r ON m.meter_id=r.meter_id AND w.ts=r.ts
GROUP BY w.humidity_pct;

SELECT r.ts, r.load_kw, w.solar_irradiance
FROM meter_readings r
JOIN meters m ON r.meter_id = m.meter_id
JOIN feeders f ON m.feeder_id = f.feeder_id
JOIN zones z ON f.zone_id = z.zone_id
JOIN weather w ON r.ts = w.ts
WHERE w.solar_irradiance BETWEEN 300 AND 700;

SELECT z.zone_name, corr(w.solar_irradiance, r.load_kw)
FROM weather w
JOIN zones z ON w.zone_id=z.zone_id
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id
JOIN meter_readings r ON m.meter_id=r.meter_id AND w.ts=r.ts
GROUP BY z.zone_name;

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN weather w ON r.ts=w.ts
WHERE w.temperature_c > 30
GROUP BY z.zone_name;


ðŸŸ£ BLOCK 4 â€” BILLING & TARIFF SQL (50 Queries)

SELECT r.ts, r.load_kw, t.rate_per_kwh, (r.load_kw * t.rate_per_kwh) AS cost
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time;

SELECT SUM(r.load_kw * t.rate_per_kwh) AS total_bill
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
WHERE r.meter_id='MTR001';

SELECT z.zone_name, SUM(r.load_kw * t.rate_per_kwh) AS zone_revenue
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY z.zone_name;

SELECT m.customer_type, SUM(r.load_kw * t.rate_per_kwh) AS total_cost
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY m.customer_type;

SELECT meter_id, SUM(load_kw) AS total_kwh
FROM meter_readings
GROUP BY meter_id;

SELECT z.zone_name, tariff.label, AVG(t.rate_per_kwh)
FROM tariffs t
JOIN zones z ON t.zone_id=z.zone_id
GROUP BY z.zone_name, t.label;

SELECT m.meter_id, MAX(r.load_kw) AS peak_load
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.meter_id;

SELECT z.zone_name, COUNT(m.meter_id) AS meter_count
FROM meters m
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE m.customer_type='Residential';

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE m.customer_type='Industrial';

SELECT t.label, t.rate_per_kwh
FROM tariffs t;

SELECT r.ts, r.load_kw
FROM meter_readings r
WHERE strftime('%H:%M', r.ts) BETWEEN '18:00' AND '22:00';

SELECT SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE m.customer_type='Commercial';

SELECT r.ts, r.load_kw, t.rate_per_kwh
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id
WHERE t.label='peak'
AND time(r.ts) BETWEEN t.start_time AND t.end_time;

SELECT SUM(r.load_kw) AS consumption, z.zone_name
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT t.label, SUM(r.load_kw * t.rate_per_kwh) AS total_revenue
FROM tariffs t
JOIN zones z ON t.zone_id=z.zone_id
JOIN feeders f ON z.zone_id=f.zone_id
JOIN meters m ON f.feeder_id=m.feeder_id
JOIN meter_readings r ON m.meter_id=r.meter_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY t.label;

SELECT meter_id, AVG(load_kw)
FROM meter_readings
WHERE ts >= datetime('now','-7 days')
GROUP BY meter_id;

SELECT z.zone_name, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts >= datetime('now','-7 days')
GROUP BY z.zone_name;

SELECT m.meter_id, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.meter_id;

SELECT m.meter_id, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE time(r.ts) BETWEEN '00:00' AND '06:00'
GROUP BY m.meter_id;

SELECT z.zone_name, AVG(r.load_kw) AS night_load
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE time(r.ts) BETWEEN '00:00' AND '06:00'
GROUP BY z.zone_name;

SELECT meter_id, r.ts, r.load_kw
FROM meter_readings r
WHERE r.load_kw = (
    SELECT MAX(load_kw) FROM meter_readings WHERE meter_id=r.meter_id
);

SELECT meter_id, r.ts, r.load_kw
FROM meter_readings r
WHERE r.load_kw = (
    SELECT MIN(load_kw) FROM meter_readings WHERE meter_id=r.meter_id
);

SELECT m.customer_type, AVG(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.customer_type;

SELECT f.feeder_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_name;

SELECT f.feeder_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_name;

SELECT SUM(r.load_kw * t.rate_per_kwh) AS peak_cost
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id
WHERE t.label='peak';

SELECT SUM(r.load_kw * t.rate_per_kwh) AS offpeak_cost
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id
WHERE t.label='offpeak';

SELECT COUNT(*)
FROM meter_readings
WHERE load_kw > 50;

SELECT COUNT(*)
FROM meter_readings
WHERE load_kw < 5;

SELECT AVG(r.load_kw), t.label
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY t.label;

SELECT SUM(r.load_kw * t.rate_per_kwh)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id
WHERE date(r.ts) = date('now','-1 day');

SELECT z.zone_name, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT m.customer_type, SUM(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.customer_type;

SELECT r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN tariffs t ON time(r.ts) BETWEEN t.start_time AND t.end_time
WHERE t.label='offpeak';

SELECT SUM(r.load_kw * CASE WHEN time(r.ts) BETWEEN '18:00' AND '22:00' THEN 10 ELSE 5 END)
FROM meter_readings r;

SELECT m.meter_id, SUM(r.load_kw * t.rate_per_kwh) AS bill_amount
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY m.meter_id;

SELECT meter_id, SUM(load_kw)
FROM meter_readings
WHERE ts BETWEEN datetime('now','-30 days') AND datetime('now')
GROUP BY meter_id;

SELECT z.zone_name, t.label, SUM(r.load_kw * t.rate_per_kwh)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY z.zone_name, t.label;

SELECT meter_id, COUNT(*)
FROM meter_readings
WHERE load_kw > 40
GROUP BY meter_id;

SELECT z.zone_name, AVG(r.load_kw * t.rate_per_kwh)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
JOIN tariffs t ON z.zone_id=t.zone_id AND time(r.ts) BETWEEN t.start_time AND t.end_time
GROUP BY z.zone_name;


ðŸŸ¥ BLOCK 5 â€” PART A (50 ANOMALY DETECTION SQL QUERIES)

SELECT meter_id, AVG(load_kw) AS avg_load
FROM meter_readings
GROUP BY meter_id
HAVING avg_load > (SELECT AVG(load_kw)*1.5 FROM meter_readings);

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (SELECT AVG(load_kw) + 2*STDDEV(load_kw) FROM meter_readings);

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
JOIN (
    SELECT meter_id, AVG(load_kw) AS avg_load, STDDEV(load_kw) AS sd
    FROM meter_readings
    GROUP BY meter_id
) x ON r.meter_id=x.meter_id
WHERE r.load_kw > x.avg_load + 2.5*x.sd;

SELECT meter_id, COUNT(*) AS abnormal_points
FROM meter_readings
WHERE load_kw < 0
GROUP BY meter_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw = 0
ORDER BY ts DESC;

SELECT m.meter_id, r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE r.load_kw > 3 * (SELECT AVG(load_kw) FROM meter_readings WHERE meter_id=r.meter_id);

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
WHERE load_kw > 1.5 * (
    SELECT AVG(load_kw) FROM meter_readings
    WHERE meter_id=r.meter_id
);

SELECT meter_id, COUNT(*) AS anomaly_count
FROM meter_readings
WHERE load_kw > 50
GROUP BY meter_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 60;

SELECT m.meter_id, r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE r.load_kw > 40 AND m.customer_type='Residential';

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
WHERE load_kw > (SELECT AVG(load_kw)+3*(SELECT STDDEV(load_kw) FROM meter_readings))
ORDER BY load_kw DESC;

SELECT meter_id, MIN(load_kw)
FROM meter_readings
GROUP BY meter_id
HAVING MIN(load_kw)=0;

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
WHERE load_kw < (SELECT AVG(load_kw)/4 FROM meter_readings WHERE meter_id=r.meter_id);

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > 2*(SELECT AVG(load_kw) FROM meter_readings WHERE meter_id=meter_readings.meter_id);

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw < 2;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 45 AND strftime('%H', ts) BETWEEN '00' AND '05';

SELECT meter_id, COUNT(*)
FROM meter_readings
WHERE load_kw > 3*(SELECT AVG(load_kw) FROM meter_readings)
GROUP BY meter_id;

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE m.customer_type='Commercial'
AND r.load_kw > 2*(SELECT AVG(load_kw) FROM meter_readings);

SELECT z.zone_name, COUNT(*) AS anomalies
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.load_kw > (SELECT AVG(load_kw) + 2*STDDEV(load_kw) FROM meter_readings)
GROUP BY z.zone_name;

SELECT meter_id, MAX(load_kw)
FROM meter_readings
GROUP BY meter_id
HAVING MAX(load_kw) > 75;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw BETWEEN 0 AND 1;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE ABS(load_kw - (SELECT AVG(load_kw) FROM meter_readings WHERE meter_id=meter_readings.meter_id)) > 20;

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > 100;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (SELECT AVG(load_kw) FROM meter_readings) * 2;

SELECT m.meter_id, r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE r.load_kw > 4 * (
    SELECT AVG(load_kw) FROM meter_readings WHERE meter_id=r.meter_id
);

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw < 0.5;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 90;

SELECT m.customer_type, COUNT(*) AS anomaly_points
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE r.load_kw > 40
GROUP BY m.customer_type;

SELECT feeder_id, COUNT(*) AS abnormal_timestamps
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.feeder_id
HAVING COUNT(*) > 100;

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
WHERE r.load_kw < (SELECT AVG(load_kw)/3 FROM meter_readings);

SELECT z.zone_name, AVG(r.load_kw) AS suspicious_low_avg
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name
HAVING suspicious_low_avg < 5;

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > 70 AND strftime('%w', ts) IN ('6','0');

SELECT meter_id, COUNT(*)
FROM meter_readings
WHERE load_kw < 1
GROUP BY meter_id
HAVING COUNT(*) > 20;

SELECT r.meter_id, r.ts, r.load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE m.customer_type='Industrial'
AND r.load_kw < 5;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 85;

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > (SELECT AVG(load_kw) FROM meter_readings)*1.8;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 55 AND strftime('%H', ts)='23';

SELECT m.customer_type, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.customer_type;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw < (SELECT AVG(load_kw)*0.2 FROM meter_readings);

SELECT z.zone_name, COUNT(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.load_kw > 60
GROUP BY z.zone_name;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 95;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE ABS(load_kw - (SELECT AVG(load_kw) FROM meter_readings)) > 30;



SELECT ts, load_kw
FROM meter_readings
WHERE meter_id='MTR001'
ORDER BY load_kw DESC
LIMIT 10;

SELECT f.feeder_name, MAX(r.load_kw) AS peak_load
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id
ORDER BY peak_load DESC;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE strftime('%H', ts) BETWEEN '18' AND '22'
ORDER BY load_kw DESC
LIMIT 20;

SELECT meter_id, AVG(load_kw) AS evening_avg
FROM meter_readings
WHERE strftime('%H', ts) BETWEEN '18' AND '23'
GROUP BY meter_id
ORDER BY evening_avg DESC;

SELECT m.meter_id, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE m.customer_type='Residential'
GROUP BY m.meter_id;

SELECT ts, load_kw
FROM meter_readings
WHERE DATE(ts)=DATE('now','-1 day')
ORDER BY load_kw DESC
LIMIT 5;

SELECT meter_id, MAX(load_kw)
FROM meter_readings
WHERE strftime('%w', ts)='0'
GROUP BY meter_id;

SELECT f.feeder_name, SUM(r.load_kw) AS total_peak_period_load
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
WHERE strftime('%H', ts) BETWEEN '17' AND '21'
GROUP BY f.feeder_id;

SELECT zone_name, SUM(load_kw) AS zone_peak_sum
FROM (
    SELECT z.zone_name, r.load_kw
    FROM meter_readings r
    JOIN meters m ON r.meter_id=m.meter_id
    JOIN feeders f ON m.feeder_id=f.feeder_id
    JOIN zones z ON f.zone_id=z.zone_id
    WHERE r.load_kw > (SELECT AVG(load_kw) FROM meter_readings)
)
GROUP BY zone_name;

SELECT meter_id, ts, load_kw
FROM meter_readings
ORDER BY load_kw DESC
LIMIT 1;

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw = (SELECT MAX(load_kw) FROM meter_readings);

SELECT z.zone_name, AVG(r.load_kw) AS avg_peak
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE strftime('%H', ts) BETWEEN '19' AND '22'
GROUP BY z.zone_id;

SELECT meter_id, MAX(load_kw)
FROM meter_readings
WHERE strftime('%m', ts)=strftime('%m','now')
GROUP BY meter_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 40
ORDER BY ts ASC;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts >= DATETIME('now','-7 days')
GROUP BY z.zone_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE DATE(ts)=DATE('now','-7 days')
ORDER BY load_kw DESC;

SELECT meter_id, AVG(load_kw) AS morning_peak
FROM meter_readings
WHERE strftime('%H', ts) BETWEEN '06' AND '09'
GROUP BY meter_id;

SELECT meter_id, AVG(load_kw) AS night_peak
FROM meter_readings
WHERE strftime('%H', ts) BETWEEN '23' AND '02'
GROUP BY meter_id
ORDER BY night_peak DESC;

SELECT f.feeder_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
GROUP BY f.feeder_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (
      SELECT AVG(load_kw) + STDDEV(load_kw)
      FROM meter_readings
)
ORDER BY load_kw DESC;

SELECT z.zone_name, COUNT(*)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.load_kw > 35
GROUP BY z.zone_name;

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > 50;

SELECT meter_id, AVG(load_kw) AS average_peak_load
FROM meter_readings
WHERE strftime('%H', ts) BETWEEN '18' AND '23'
GROUP BY meter_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (
    SELECT AVG(load_kw)*1.7 FROM meter_readings WHERE meter_id=meter_readings.meter_id
);

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw = (
    SELECT MAX(load_kw) FROM meter_readings WHERE meter_id=meter_readings.meter_id
);

SELECT m.customer_type, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.customer_type;

SELECT meter_id, COUNT(*)
FROM meter_readings
WHERE load_kw > 30
GROUP BY meter_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE strftime('%w', ts)='6'
ORDER BY load_kw DESC
LIMIT 10;

SELECT z.zone_name, MAX(r.load_kw)
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
GROUP BY z.zone_name
ORDER BY MAX(r.load_kw) DESC;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 85
ORDER BY ts DESC;

SELECT meter_id, AVG(load_kw)
FROM meter_readings
GROUP BY meter_id
ORDER BY AVG(load_kw) DESC
LIMIT 5;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (SELECT AVG(load_kw)+10 FROM meter_readings);

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > 2*(SELECT AVG(load_kw) FROM meter_readings)
ORDER BY ts;

SELECT meter_id, load_kw
FROM meter_readings
WHERE DATE(ts)=DATE('now')
ORDER BY load_kw DESC;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (
    SELECT AVG(load_kw)*1.4 FROM meter_readings WHERE meter_id=meter_readings.meter_id
);

SELECT zone_name, MAX(load_kw)
FROM (
    SELECT z.zone_name, r.load_kw
    FROM meter_readings r
    JOIN meters m ON r.meter_id=m.meter_id
    JOIN feeders f ON m.feeder_id=f.feeder_id
    JOIN zones z ON f.zone_id=z.zone_id
)
GROUP BY zone_name;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > 95;

SELECT strftime('%H', ts) AS hour, MAX(load_kw)
FROM meter_readings
GROUP BY hour
ORDER BY MAX(load_kw) DESC;

SELECT meter_id, ts, load_kw
FROM meter_readings
ORDER BY load_kw DESC
LIMIT 50;

SELECT z.zone_name, ts, load_kw
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
ORDER BY load_kw DESC
LIMIT 20;

SELECT meter_id, ts
FROM meter_readings
WHERE load_kw > 60;

SELECT m.customer_type, AVG(r.load_kw) AS peak_usage
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE strftime('%H', ts) BETWEEN '17' AND '21'
GROUP BY m.customer_type;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE DATE(ts)=DATE('now','-2 days')
ORDER BY load_kw DESC
LIMIT 5;

ðŸŸ¦ BLOCK 5 â€” PART C â€” Forecast-Aware & Trend SQL (50 queries)

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 1) OVER (ORDER BY ts) AS delta
FROM meter_readings
WHERE meter_id='MTR001'
ORDER BY ts;

SELECT ts, load_kw,
       AVG(load_kw) OVER (ORDER BY ts ROWS 5 PRECEDING) AS moving_avg
FROM meter_readings
WHERE meter_id='MTR001';

SELECT meter_id,
       AVG(load_kw) AS last_24h_avg
FROM meter_readings
WHERE ts >= DATETIME('now','-24 hours')
GROUP BY meter_id;

SELECT meter_id,
       (AVG(load_kw) - (
            SELECT AVG(load_kw)
            FROM meter_readings
            WHERE ts BETWEEN DATETIME('now','-2 days') AND DATETIME('now','-1 day')
       )) AS trend_change
FROM meter_readings
WHERE ts >= DATETIME('now','-1 day')
GROUP BY meter_id;

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 4) OVER (ORDER BY ts) AS one_hour_change
FROM meter_readings
WHERE meter_id='MTR002';

SELECT ts, load_kw,
       CASE WHEN load_kw > LAG(load_kw,1) OVER (ORDER BY ts)
            THEN 'up'
            ELSE 'down'
       END AS trend_direction
FROM meter_readings
WHERE meter_id='MTR001';

SELECT strftime('%Y-%m-%d', ts) AS day,
       AVG(load_kw) AS avg_load
FROM meter_readings
GROUP BY day
ORDER BY day;

SELECT meter_id,
       MAX(load_kw) - MIN(load_kw) AS volatility
FROM meter_readings
WHERE ts >= DATETIME('now','-7 days')
GROUP BY meter_id;

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 96) OVER (ORDER BY ts) AS daily_cycle_diff
FROM meter_readings
WHERE meter_id='MTR001';

SELECT strftime('%H', ts) AS hour,
       AVG(load_kw) AS avg_hourly
FROM meter_readings
GROUP BY hour
ORDER BY hour;

SELECT meter_id,
       AVG(load_kw) FILTER (WHERE load_kw > 20) AS high_load_avg
FROM meter_readings
GROUP BY meter_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE ts >= (
   SELECT MAX(ts) FROM meter_readings
) AND ts <= DATETIME((SELECT MAX(ts) FROM meter_readings), '+1 hour');

SELECT z.zone_name,
       AVG(r.load_kw) AS last_week_avg
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE r.ts >= DATETIME('now','-7 days')
GROUP BY z.zone_name;

SELECT ts, load_kw,
       (load_kw - (
            SELECT AVG(load_kw)
            FROM meter_readings
            WHERE DATE(ts)=DATE(meter_readings.ts)
       )) AS deviation_from_daily_avg
FROM meter_readings;

SELECT meter_id,
       AVG(load_kw) AS avg_current_week,
       (SELECT AVG(load_kw)
        FROM meter_readings r2
        WHERE r2.meter_id=meter_readings.meter_id
          AND r2.ts BETWEEN DATETIME('now','-14 days') AND DATETIME('now','-7 days')
       ) AS avg_last_week
FROM meter_readings
WHERE ts >= DATETIME('now','-7 days')
GROUP BY meter_id;

SELECT ts, load_kw,
       AVG(load_kw) OVER (
           ORDER BY ts ROWS BETWEEN 15 PRECEDING AND CURRENT ROW
       ) AS smoother
FROM meter_readings;

SELECT m.meter_id,
       AVG(r.load_kw) AS weekday_avg,
       (SELECT AVG(load_kw)
        FROM meter_readings r2
        WHERE r2.meter_id=m.meter_id
          AND strftime('%w', r2.ts) IN ('0','6')) AS weekend_avg
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
WHERE strftime('%w', r.ts) BETWEEN '1' AND '5'
GROUP BY m.meter_id;

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 96) OVER (ORDER BY ts) AS day_over_day_change
FROM meter_readings;

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 4) OVER (ORDER BY ts) AS fifteen_min_change
FROM meter_readings;

SELECT feeder_id,
       AVG(load_kw) AS avg_load,
       MAX(load_kw) - MIN(load_kw) AS range_load
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY feeder_id;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE load_kw > (
    SELECT AVG(load_kw)*1.3 FROM meter_readings
);

SELECT strftime('%Y-%m', ts) AS month,
       MAX(load_kw) AS monthly_peak,
       AVG(load_kw) AS monthly_avg
FROM meter_readings
GROUP BY month;

SELECT ts, load_kw,
       CASE WHEN load_kw > (
            SELECT AVG(load_kw)
            FROM meter_readings r2
            WHERE DATE(r2.ts) = DATE(meter_readings.ts)
       )
       THEN 'above_daily_norm'
       ELSE 'below_daily_norm'
       END AS status
FROM meter_readings;

SELECT z.zone_name,
       AVG(r.load_kw) AS rise_rate
FROM (
    SELECT *, load_kw - LAG(load_kw,1) OVER (ORDER BY ts) AS diff
    FROM meter_readings
) r
JOIN meters m ON r.meter_id=m.meter_id
JOIN feeders f ON m.feeder_id=f.feeder_id
JOIN zones z ON f.zone_id=z.zone_id
WHERE diff > 0
GROUP BY z.zone_name;

SELECT meter_id,
       AVG(load_kw) AS avg_load,
       AVG(load_kw) FILTER (WHERE load_kw > 30) AS avg_peak
FROM meter_readings
GROUP BY meter_id;

SELECT ts, load_kw,
       (load_kw - LAG(load_kw, 1) OVER (ORDER BY ts)) AS slope
FROM meter_readings
WHERE meter_id='MTR010';

SELECT meter_id,
       SUM(load_kw) AS weekly_energy
FROM meter_readings
WHERE ts >= DATETIME('now','-7 days')
GROUP BY meter_id;

SELECT strftime('%H', ts) AS hour,
       MAX(load_kw) AS hour_peak
FROM meter_readings
GROUP BY hour
ORDER BY hour_peak DESC;

SELECT ts, load_kw,
       CASE WHEN load_kw > (
            SELECT AVG(load_kw)
        ) THEN 'future_peak_signal'
       ELSE 'normal'
       END AS signal
FROM meter_readings;

SELECT meter_id,
       AVG(load_kw) AS rolling_week_average
FROM meter_readings
WHERE ts >= DATETIME('now','-7 days')
GROUP BY meter_id;

SELECT meter_id,
       SUM(CASE WHEN load_kw > 20 THEN 1 ELSE 0 END) AS high_usage_points
FROM meter_readings
GROUP BY meter_id;

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 24) OVER (ORDER BY ts) AS day_step_change
FROM meter_readings;

SELECT ts, load_kw,
       ROUND(AVG(load_kw) OVER (ORDER BY ts ROWS 10 PRECEDING), 2) AS smoothed
FROM meter_readings;

SELECT strftime('%d', ts) AS day,
       AVG(load_kw) AS avg_per_day
FROM meter_readings
GROUP BY day;

SELECT zone_name, AVG(load_kw)
FROM (
    SELECT z.zone_name, r.load_kw
    FROM meter_readings r
    JOIN meters m ON r.meter_id=m.meter_id
    JOIN feeders f ON m.feeder_id=f.feeder_id
    JOIN zones z ON f.zone_id=z.zone_id
)
GROUP BY zone_name;

SELECT meter_id, ts, load_kw,
       load_kw - (
            SELECT AVG(load_kw)
            FROM meter_readings r2
            WHERE r2.meter_id=meter_readings.meter_id
       ) AS deviation_from_meter_avg
FROM meter_readings;

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 8) OVER (ORDER BY ts) AS two_hour_delta
FROM meter_readings;

SELECT meter_id, ts, load_kw
FROM meter_readings
WHERE ts BETWEEN DATETIME('now','-48 hours') AND DATETIME('now');

SELECT ts, load_kw,
       load_kw - LAG(load_kw, 12) OVER (ORDER BY ts) AS three_hour_change
FROM meter_readings;

SELECT meter_id,
       MAX(load_kw) AS highest_point,
       MIN(load_kw) AS lowest_point,
       (MAX(load_kw) - MIN(load_kw)) AS variation
FROM meter_readings
GROUP BY meter_id;

SELECT m.customer_type,
       AVG(r.load_kw) AS avg_usage,
       MAX(r.load_kw) AS peak_usage
FROM meter_readings r
JOIN meters m ON r.meter_id=m.meter_id
GROUP BY m.customer_type;

SELECT ts, load_kw,
       AVG(load_kw) OVER (ORDER BY ts ROWS BETWEEN 20 PRECEDING AND 20 FOLLOWING) AS centered_smoothing
FROM meter_readings;

SELECT meter_id,
       AVG(CASE WHEN load_kw > 25 THEN load_kw END) AS avg_high_load_window
FROM meter_readings
GROUP BY meter_id;

SELECT zone_name,
       COUNT(*) AS positive_trend_count
FROM (
    SELECT z.zone_name, r.load_kw,
           r.load_kw - LAG(r.load_kw,1) OVER (ORDER BY r.ts) AS change
    FROM meter_readings r
    JOIN meters m ON r.meter_id=m.meter_id
    JOIN feeders f ON m.feeder_id=f.feeder_id
    JOIN zones z ON f.zone_id=z.zone_id
)
WHERE change > 0
GROUP BY zone_name;



